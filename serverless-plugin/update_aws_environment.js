#!/usr/bin/env node
// Update the list of libraries included in the AWS Lambda environment

'use strict';

const {spawnSync} = require('child_process');
const fs = require('fs-extra');
const path = require('path');

const config = require('./config');
const ld = require('./ld');

const LAMBDA_IMAGE = 'lambci/lambda:' + config.BASE_RUNTIME;

const EXPORT_FILE_NAME = path.resolve(__dirname, 'aws_environment.js');

function getLibraries() {
    const lddResult = spawnSync(
        'docker',
        [
            'run',
            '--rm',
            '--entrypoint', '/usr/sbin/ldconfig',
            LAMBDA_IMAGE,
            '-c', 'new',
            '-p'
        ]
    );

    if (lddResult.error || lddResult.status > 0) {
        console.log("Error calling ldconfig in the AWS image.");
        console.log(lddResult.stderr.toString('utf8').trim());
        throw "Error calling ldconfig";
    }

    const lddOutput = lddResult.stdout.toString('utf8').trim();

    const libraries = Object.keys(ld.parseLdOutput(lddOutput));

    return libraries;
};

function main() {
    let content = "// This file is autogenerated.\n" +
        "// Please use 'npm run update-aws-environment' to update.\n";

    function add_export(name, value) {
        return "module.exports." + name + " = " +
            JSON.stringify(value, null, 4) + "\n";
    }

    content += add_export("libraries", getLibraries());

    fs.writeFileSync(EXPORT_FILE_NAME, content);
}

main();
